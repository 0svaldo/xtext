allprojects {
  ext.intellijHome = file("${rootDir}/intellij-ce")
  ext.os = org.gradle.internal.os.OperatingSystem.current()
  ext.intellijLibs = file("${intellijHome}/lib")
}

def repositoryUrl = 'https://teamcity.jetbrains.com/repository/download/bt410/153679:id'
def buildQualifier = '138.SNAPSHOT'
def archiveName
if (os.windows) {
  archiveName = "ideaIC-${buildQualifier}.win.zip"
} else if (os.macOsX) {
  archiveName = "ideaIC-${buildQualifier}.mac.zip"
} else if (os.linux) {
  archiveName = "ideaIC-${buildQualifier}.tar.gz"
}
def archiveFile = file("${intellijHome}/${archiveName}")

task downloadIntellij {
  onlyIf {!archiveFile.exists()}
  doLast {
    intellijHome.mkdirs()
    ant.get(src:"${repositoryUrl}/${archiveName}?guest", dest: intellijHome)
    ant.get(src:"${repositoryUrl}/sources.zip?guest', dest: intellijHome)
  }
}

task unpackIntellij(type: Copy, dependsOn: downloadIntellij) {
  into(intellijHome)
  if (os.linux) {
    from tarTree(archiveFile)
    eachFile {file ->
      file.path = file.path - "idea-IC-${buildQualifier}/"
    }
  } else {
    from zipTree(archiveFile)
    if (os.macOsX) {
      eachFile {file ->
        file.path = file.path - "IntelliJ IDEA 14 CE EAP.app/Contents/"
      }
    }
  }
}

task prepareIntellij(dependsOn: [unpackIntellij, ':intellij-dependencies:eclipseClasspath'])

task cleanTestSystem(type: Delete) {
  delete "${intellijHome}/test-system"
}

task cleanIntellij(type: Delete) {
  delete intellijHome
}