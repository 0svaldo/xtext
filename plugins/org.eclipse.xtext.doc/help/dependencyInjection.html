<html>
<head>
<META http-equiv="Content-Type" content="text/html; charset=ISO-8859-1">
<title>Dependency Injection in Xtext with Google Guice</title>
<link href="book.css" rel="stylesheet" type="text/css">
<meta content="DocBook XSL Stylesheets V1.75.1" name="generator">
<link rel="home" href="index.html" title="Xtext User Guide">
<link rel="up" href="configuration.html" title="Configuration">
<link rel="prev" href="configuration.html" title="Configuration">
<link rel="next" href="RuntimeConcepts.html" title="Runtime Concepts">
</head>
<body bgcolor="white" text="black" link="#0000FF" vlink="#840084" alink="#0000FF">
<h1 xmlns:l="http://docbook.sourceforge.net/xmlns/l10n/1.0">Dependency Injection in Xtext with Google Guice</h1>
<p>In Xtext, there are many Java classes which implement logic, behavior, or supply configuration. These classes implement Java interfaces and are typically only supposed to be accessed through these interfaces, which makes their implementations interchangeable. This is where Xtext utilizes 
				<a class="ulink" href="http://code.google.com/p/google-guice/" target="_new">Google Guice</a>: 
			</p>
<div class="itemizedlist">
<ul class="itemizedlist" type="disc">
<li class="listitem">
<p>Guice manages the instantiation of the classes: instead of constructing a class with 
						<code class="code">new</code>, the <code class="code">@Inject</code> annotation instructs Guice to supply an object for a certain interface. Such an object is called 
						<a class="link" href="">Service</a>.
					</p>
</li>
<li class="listitem">
<p>Guice allows to configure which implementations are to be supplied for which interface. This configuration consists of so-called 
						<a class="link" href="dependencyInjection.html#guicemodules" title="Modules">modules</a>.
					</p>
</li>
</ul>
</div>
<div class="section" title="Services">
<div class="titlepage">
<div>
<div>
<h3 class="title">
<a name="guiceservice"></a>Services</h3>
</div>
</div>
</div>
<p>The most parts of Xtext are implemented as 
					<span class="emphasis"><em>services</em></span>. A service is an object which implements a certain interface and which is instantiated and provided by Guice.
				</p>
<p>Xtext ships with generic default implementations for the most services or uses 
					<a class="link" href="configuration.html#generator" title="The Generator">generator fragments</a> to automatically generate service implementations for a grammar. Thereby, Xtext strives to provide meaningful implementations out of the box and to allow customization wherever needed. Developers are encouraged to sub-class existing services and configure them for their languages in their 
					<a class="link" href="dependencyInjection.html#guicemodules" title="Modules">modules</a>.  
				</p>
<p>When Guice instantiates an object, it also supplies this instance with all its dependent services. All a service does is to request &ldquo;some implementation for a certain interface&rdquo; using the <code class="code">@Inject</code>-annotation. Based on the 
					<a class="link" href="dependencyInjection.html#guicemodules" title="Modules">modules configuration</a> Guice decides which class to instantiate or which object to reuse. 
				</p>
<p>For example, Guice can automatically initialize member variables with the needed services. </p>
<div class="literallayout">
<p>
<code class="code">
<br>
public&nbsp;class&nbsp;MyLanguageLinker&nbsp;extends&nbsp;Linker&nbsp;{<br>

<br>
&nbsp;&nbsp;@Inject<br>
&nbsp;&nbsp;private&nbsp;IScopeProvider&nbsp;scopeProvider;<br>

<br>
&nbsp;&nbsp;@Inject(optional=true)<br>
&nbsp;&nbsp;private&nbsp;IXtext2EcorePostProcessor&nbsp;postProcessor;<br>
&nbsp;&nbsp;<br>
&nbsp;&nbsp;(...)<br>
}<br>

<br>

</code>
</p>
</div>
<p>Furthermore, Guice can pass the needed services as constructor parameters.</p>
<div class="literallayout">
<p>
<code class="code">
<br>
public&nbsp;class&nbsp;MyLanguageGrammarAccess&nbsp;implements&nbsp;IGrammarAccess&nbsp;{<br>
	
<br>
&nbsp;&nbsp;private&nbsp;final&nbsp;GrammarProvider&nbsp;grammarProvider;<br>

<br>
&nbsp;&nbsp;private&nbsp;TerminalsGrammarAccess&nbsp;gaTerminals;<br>

<br>
&nbsp;&nbsp;@Inject<br>
&nbsp;&nbsp;public&nbsp;MyLanguageGrammarAccess(GrammarProvider&nbsp;grammarProvider,<br>
&nbsp;&nbsp;&nbsp;&nbsp;TerminalsGrammarAccess&nbsp;gaTerminals)&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;this.grammarProvider&nbsp;=&nbsp;grammarProvider;<br>
&nbsp;&nbsp;&nbsp;&nbsp;this.gaTerminals&nbsp;=&nbsp;gaTerminals;<br>
&nbsp;&nbsp;}<br>
	
<br>
&nbsp;&nbsp;(...)<br>
}<br>

<br>

</code>
</p>
</div>
<p>For further details, please refer to the 
					<a class="ulink" href="http://code.google.com/docreader/#p=google-guice&s=google-guice&t=UsersGuide" target="_new">Google Guice Documentation</a>
				
</p>
</div>
<div class="section" title="Modules">
<div class="titlepage">
<div>
<div>
<h3 class="title">
<a name="guicemodules"></a>Modules</h3>
</div>
</div>
</div>
<p>The configuration of services for a language built with  Xtext is done via modules:</p>
<div class="itemizedlist">
<ul class="itemizedlist" type="disc">
<li class="listitem">
<p>Modules map (bind) arbitrary Java interfaces to their implementation classes or directly to instances of their implementation classes.</p>
</li>
<li class="listitem">
<p>A module itself is a plain Java class.</p>
</li>
<li class="listitem">
<p>Modules can inherit from each other and override bindings that are declared in super-modules.</p>
</li>
<li class="listitem">
<p>In Xtext, there is a 
							<a class="link" href="dependencyInjection.html#guicedefaultmodule" title="Default Module">generic default module</a> for all languages, there are automatically 
							<a class="link" href="dependencyInjection.html#guicegeneratedmodule" title="Generated Modules">generated modules</a> and there are modules which are 
							<a class="link" href="dependencyInjection.html#guicemanualmodules" title="Modules intended for customization">intended to be customized manually</a>.  
						</p>
</li>
<li class="listitem">
<p>Furthermore, Xtext distinguishes between modules for runtime-services and modules related to services needed for the user interface.</p>
</li>
</ul>
</div>
<p>In total, this leads to five modules for a typical Xtext Language. They are visualized in the image below. The image is further explained in the following subsections. </p>
<p>
					
</p>
<div class="mediaobject">
<img src="images/modules_hierarchy.png"></div>
<p>
				
</p>
<div class="section" title="Modules intended for customization">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="guicemanualmodules"></a>Modules intended for customization</h4>
</div>
</div>
</div>
<p>When the 
						<a class="link" href="configuration.html#generator" title="The Generator">generator</a> runs the first time, it creates two modules named 
						<code class="code">&lt;MyLanguage&gt;RuntimeModule</code> and 
						<code class="code">&lt;MyLanguage&gt;UIModule</code>. They are placed in the language&rsquo;s root-package in the 
						<code class="code">src/</code>-folder of the language&rsquo;s runtime-project and the language&rsquo;s UI-project. Both are initially empty and will never be overwritten by the generator. They are 
						<a class="ulink" href="guicecustomize" target="_new">intended for customization</a>. By default, they extend a 
						<a class="link" href="dependencyInjection.html#guicegeneratedmodule" title="Generated Modules">generated module</a>.  
					</p>
</div>
<div class="section" title="Generated Modules">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="guicegeneratedmodule"></a>Generated Modules</h4>
</div>
</div>
</div>
<p>The fully generated modules (never touch them!) are called 
						<code class="code">Abstract&lt;MyLanguage&gt;RuntimeModule</code> and 
						<code class="code">Abstract&lt;MyLanguage&gt;UiModule</code> respectively. They contain all components which have been generated specifically for the language at hand. What goes into these modules depends on the fragments you use in the generator.
					</p>
</div>
<div class="section" title="Default Module">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="guicedefaultmodule"></a>Default Module</h4>
</div>
</div>
</div>
<p>Finally the fully generated modules extend the 
						<a class="ulink" href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.tmf/org.eclipse.xtext/plugins/org.eclipse.xtext/src/org/eclipse/xtext/service/DefaultRuntimeModule.java?root=Modeling_Project&view=co" target="_new">DefaultRuntimeModule</a>, which contains all the default configuration. The default configuration consists of all components for which we have generic default implementations. 
					</p>
</div>
<div class="section" title="Changing Configuration">
<div class="titlepage">
<div>
<div>
<h4 class="title">
<a name="guicecustomize"></a>Changing Configuration</h4>
</div>
</div>
</div>
<p>We use the primary modules (
						<code class="code">&lt;MyLanguage&gt;RuntimeModule</code> and 
						<code class="code">&lt;MyLanguage&gt;UiModule</code>) in order to change the configuration. 
						These classes are initially empty and have been generated to allow customization.
					</p>
<p>In order to provide a simple and convenient way, the DefaultModule extends 
						<a class="ulink" href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.tmf/org.eclipse.xtext/plugins/org.eclipse.xtext/src/org/eclipse/xtext/service/AbstractGenericModule.java?root=Modeling_Project&view=co" target="_new">AbstractGenericModule</a>. 
						Which does not provide any bindings but comes up with a convenient and declarative way to specify mappings. The default API provided by Guice is based on fluent API and a builder pattern.
						This is also very readable but does not allow sub modules to change any of the bindings.   
						The 
						<a class="ulink" href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.tmf/org.eclipse.xtext/plugins/org.eclipse.xtext/src/org/eclipse/xtext/service/AbstractGenericModule.java?root=Modeling_Project&view=co" target="_new">AbstractGenericModule</a> allows to declare and override bindings in all subclasses like this:
					</p>
<div class="literallayout">
<p>
<code class="code">public&nbsp;Class&lt;?&nbsp;extends&nbsp;IFooService&gt;&nbsp;bindIFooService()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MyFooServiceImpl.class;<br>
}<br>

<br>

</code>
</p>
</div>
<p>Such a method will be interpreted as a binding from 
						<code class="code">IFooService</code> to 
						<code class="code">MyFooServiceImpl.class</code>. Note that you simply have to override a method from a super class (e.g. from the generated or default module) in order to change the respective binding. For example, in the picture above, the 
						<code class="code">DefaultRuntimeModule</code> configures the 
						<a class="ulink" href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.tmf/org.eclipse.xtext/plugins/org.eclipse.xtext/src/org/eclipse/xtext/formatting/IFormatter.java?root=Modeling_Project&view=co" target="_new">IFormatter</a> to be implemented by the 
						<a class="ulink" href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.tmf/org.eclipse.xtext/plugins/org.eclipse.xtext/src/org/eclipse/xtext/formatting/impl/OneWhitespaceFormatter.java?root=Modeling_Project&view=co" target="_new">OneWhitespaceFormatter</a> and 
						<code class="code">AbstractMyLanguageModule</code> overrides this binding by binding the 
						<a class="ulink" href="http://dev.eclipse.org/viewcvs/index.cgi/org.eclipse.tmf/org.eclipse.xtext/plugins/org.eclipse.xtext/src/org/eclipse/xtext/formatting/IFormatter.java?root=Modeling_Project&view=co" target="_new">IFormatter</a> to 
						<code class="code">MyLanguageFormatter</code>.
						The type to type binding will create a new instance of the given target type for each dependency. If you want to make it a singleton, so that only one instance is created and reused for all dependencies you can add the following annotation:
					</p>
<div class="literallayout">
<p>
<code class="code">@SingletonBinding<br>
public&nbsp;Class&lt;?&nbsp;extends&nbsp;IFooService&gt;&nbsp;bindIFooService()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MyFooServiceImpl.class;<br>
}<br>

<br>

</code>
</p>
</div>
<p>In addition if the creation of the type causes any needed side effects, so you want it to be instantiated eagerly, you can set the 
						<code class="code">eager</code> property to true. Like shown in the following snippet:
					</p>
<div class="literallayout">
<p>
<code class="code">@SingletonBinding(eager=true)<br>
public&nbsp;Class&lt;?&nbsp;extends&nbsp;IFooService&gt;&nbsp;bindIFooService()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;MyFooServiceImpl.class;<br>
}<br>

<br>

</code>
</p>
</div>
<p>One more way of specify a binding is currently supported: If you need to control the way, the instance is created, you can have a type to object mapping:</p>
<div class="literallayout">
<p>
<code class="code">public&nbsp;IFooService&nbsp;bindIFooService()&nbsp;{<br>
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;new&nbsp;MyFooServiceImpl();<br>
}<br>

<br>

</code>
</p>
</div>
<p>
						
<span class="italic">Note that, although this is a convenient and simple way, you have of course also the full power of Guice, i.e. you can override the Guice method 
							<code class="code">void configure(Binder)</code> and use the afore mentioned fluent API to do whatever you want.
						</span>
					
</p>
</div>
</div>
</body>
</html>
