
h2(#dependencyInjection). Dependency Injection in Xtext with Google Guice

In Xtext, there are many Java classes which implement logic, behavior, or supply configuration. These classes implement Java interfaces and are typically only supposed to be accessed through these interfaces, which makes their implementations interchangeable. This is where Xtext utilizes "Google Guice":http://code.google.com/p/google-guice/: 
* Guice manages the instantiation of the classes: instead of constructing a class with @new@, the <code>@Inject</code> annotation instructs Guice to supply an object for a certain interface. Such an object is called "Service":#guiceserevice.
* Guice allows to configure which implementations are to be supplied for which interface. This configuration consists of so-called "modules":#guicemodules.

h3(#guiceserevice). Services

The most parts of Xtext are implemented as _services_. A service is an object which implements a certain interface and which is instantiated and provided by Guice.

Xtext ships with generic default implementations for the most services or uses "generator fragments":#generator to automatically generate service implementations for a grammar. Thereby, Xtext strives to provide meaningful implementations out of the box and to allow customization wherever needed. Developers are encouraged to sub-class existing services and configure them for their languages in their "modules":#guicemodules.  

When Guice instantiates an object, it also supplies this instance with all its dependent services. All a service does is to request "some implementation for a certain interface" using the <code>@Inject</code>-annotation. Based on the "modules":#guicemodules Guice decides which class to instantiate or which object to reuse. 

For example, Guice can automatically initialize member variables with the needed services. 

bc.. 
public class MyLanguageLinker extends Linker {

  @Inject
  private IScopeProvider scopeProvider;

  @Inject(optional=true)
  private IXtext2EcorePostProcessor postProcessor;
  
  (...)
}

p. Furthermore, Guice can pass the needed services as constructor parameters.

bc.. 
public class MyLanguageGrammarAccess implements IGrammarAccess {
	
  private final GrammarProvider grammarProvider;

  private TerminalsGrammarAccess gaTerminals;

  @Inject
  public MyLanguageGrammarAccess(GrammarProvider grammarProvider,
    TerminalsGrammarAccess gaTerminals) {
    this.grammarProvider = grammarProvider;
    this.gaTerminals = gaTerminals;
  }
	
  (...)
}

p. For further details, please refer to the "Google Guice Documentation":http://code.google.com/docreader/#p=google-guice&s=google-guice&t=UsersGuide

h3(#guicemodules). Modules

The configuration of services for an Xtext-Language is done via modules:
* Modules map (bind) arbitrary Java interfaces to their implementation classes or directly to instances of their implementation classes.
* A module itself is a plain Java class.
* Modules can inherit from each other and override bindings that are declared in super-modules.
* In Xtext, there is a "generic default module":#guicedefaultmodule for all languages, there are automatically "generated modules":#guicegeneratedmodule and there are modules which are "intended to be customized manually":#guicemanualmodules.  
* Furthermore, Xtext distinguishes between modules for runtime-services and modules related to services needed for the user interface.

In total, this leads to five modules for a typical Xtext Language. They are visualized in the image below. The image is further explained in the following subsections. 

!{width:80%}images/modules_hierarchy.png!

h4(#guicemanualmodules). Modules intended for customization

When the "generator":#generator runs the first time, it creates two modules named @[MyLanguage]RuntimeModule@ and @[MyLanguage]UIModule@. They are placed in the language's root-package in the @src/@-folder of the language's runtime-project and the language's UI-project. Both are initially empty and will never be overwritten by the generator. They are "intended for customization":guicecustomize. By default, they extend a "generated module":#guicegeneratedmodule.  

h4(#guicegeneratedmodule). Generated Modules

The fully generated modules (never touch them!) are called @Abstract[MyLanguage]RuntimeModule@ and @Abstract[MyLanguage]UiModule@ respectively. They contain all components which have been generated specifically for the language at hand. What goes into these modules depends on how your generator is configured.

h4(#guicedefaultmodule). Default Modules

Finally the fully generated modules extend the ${org.eclipse.xtext/src/org.eclipse.xtext.service.DefaultRuntimeModule}, which contains all the default configuration. The default configuration consists of all components for which we have generic default implementations. 

h4(#guicecustomize). Changing Configuration

We use the primary modules ([MyLanguage]RuntimeModule and [MyLanguage]UiModule) in order to change the configuration. 
These classes are initially empty and have been generated to allow customization.

In order to provide a simple and convenient way, in Xtext every module extends AbstractXtextModule. 
This class allows to write bindings like this:

bc.. public Class<? extends IService> bindIService() {
     return MyServiceImpl.class;
}

p. Such a method will be interpreted as a binding from @IService@ to @MyServiceImpl.class@. Note that you simply have to override a method from a super class (e.g. from the generated or default module) in order to change the respective binding. For example, in the picture above, the @DefaultRuntimeModule@ configures the ${org.eclipse.xtext/src/org.eclipse.xtext.formatting.IFormatter} to be implemented by the ${org.eclipse.xtext/src/org.eclipse.xtext.formatting.impl.OneWhitespaceFormatter} and @AbstractMyLanguageModule@ overrides this binding by binding the ${org.eclipse.xtext/src/org.eclipse.xtext.formatting.IFormatter} to @MyLanguageFormatter@.
Although this is a convenient and simple way, you have of course also the full power of Guice, i.e. you can override the Guice method @void configure(Binder)@ and do whatever you want.
